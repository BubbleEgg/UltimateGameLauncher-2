<aside id="games-list">
    <h2 class="gl-headline">STEAM</h2>
    <div id="games">

    </div>
</aside>
<div id="games-main">
    <section id="header-section">
        <div id="header-img"></div>
        <h2 id="header-name"></h2>
    </section>
    <section id="game-content">
        <ul id="menu-items">
            <li>
                <div class="launch-btn" onclick="window.startCurrentGame()">Launch</div>
            </li>
            <li>
                <div class="info-item">
                    <div class="info-title">User</div>
                    <div class="info-value" id="info-user"></div>
                </div>
            </li>
            <li>
                <div class="info-item">
                    <div class="info-title">Developer</div>
                    <div class="info-value" id="info-dev"></div>
                </div>
            </li>
        </ul>
    </section>
</div>

<script>
    var currentGame;

    const { ipcRenderer } = electron;
    const games = document.querySelector('#games');
    ipcRenderer.on('item:add', function (e, appid) {
        addApp(appid);
    });

    ipcRenderer.on('item:clear', function () {
        games.innerHTML = '';
    });

    window.removeItem = function(e) {
        e.target.parentElement.remove();
    }

    window.parseData = function(data, clear = false){
        if(clear)
            games.innerHTML = "";
        for(app of data){
            const div = document.createElement('div');
            const img = document.createElement('img');
            const name = document.createElement('div');
            div.className = 'display';
            img.className = 'display-img';
            name.className = 'display-name';
            name.innerHTML = app.displayName;
            div.setAttribute("ondblclick", "openApp("+app.appId+")");
            div.setAttribute("onClick", "window.setCurrentGame("+app.appId+")")

            img.src = 'https://steamcdn-a.akamaihd.net/steamcommunity/public/images/apps/'+app.appId+'/'+app.icon+'.jpg';
            div.appendChild(img);
            div.appendChild(name);
            games.appendChild(div);
        }
        app_saveData();
    }

    window.startCurrentGame = function() {
        openApp(currentGame.appId, app_data["apps"][currentGame.appId].user);
    }

    function sortData(data){
        data.sort(function(a, b){
            if(a.displayName < b.displayName) { return -1; }
            if(a.displayName > b.displayName) { return 1; }
            return 0;
        });
        return data;
    }

    window.setCurrentGame = function(appId){
        //https://steamcdn-a.akamaihd.net/steam/apps/4000/library_hero.jpg?t=1568744817

        const header = document.getElementById('header-img');
        const name = document.getElementById('header-name');

        image('https://steamcdn-a.akamaihd.net/steam/apps/'+appId+'/library_hero.jpg?t=1568744817', {
            success : function () {
                header.style.backgroundImage = "url('https://steamcdn-a.akamaihd.net/steam/apps/"+appId+"/library_hero.jpg?t=1568744817')";
            },
            failure : function () {
                header.style.backgroundImage = "url('https://steamcdn-a.akamaihd.net/steam/apps/"+appId+"/header.jpg?t=1568744817')";
            },
        });
        getAppsById(function(app) {
            name.innerText = app[0].displayName;
            currentGame = app[0];
            if(isDefined(app_data["apps"][appId].user))
                document.querySelector("#info-user").innerHTML = app_data["apps"][appId].user + '<i class="fas fa-chevron-down"></i>';
            document.querySelector("#info-dev").innerText = app[0].developer;
        }, [appId])
    }

    window.loadDataUser = function(first = false){
        var appsInCache = getAppIdsFromCache();
        console.log("Loading "+appsInCache.length+" games");
        getAppsById(function(apps) {
            console.log("Game data received");
            apps = sortData(apps);
            console.log("Game data sorted");
            parseData(apps);
            console.log("Game data parsed");
            if(apps.length!=0)
                window.setCurrentGame(apps[0].appId);
            loadDataFromUsers(first);
        }, appsInCache);
    }

    window.loadDataFromUsers = async function(first = false){
        users = app_getUsers();
        var all_data = [];
        var appIds = [];
        var appsInCache = getAppIdsFromCache();
        for(user of users){
            const currentUser = user;
            let p = new Promise((res, rej) => {
                getAppsFromUser(function(data){
                    for(app of data){
                        if(appIds.includes(app.appId)){
                            continue;
                        }
                        appIds.push(app.appId);

                        if(!isDefined(app_data["apps"]))
                            app_data["apps"] = {};
                        if(!isDefined(app_data["apps"][app.appId]))
                            app_data["apps"][app.appId] = {};
                        if(!isDefined(app_data["apps"][app.appId]["user"]))
                            app_data["apps"][app.appId]["user"] = currentUser.name;
                        all_data.push(app);
                    }
                    res();
                }, user.steam64id);
            });
            await p;
        }

        app_saveData();
        if(appsInCache.length == all_data.length || all_data.length == 0)
            return;
        all_data = sortData(all_data);

        parseData(all_data, true);
        if(first&&all_data[0].appId!=null&&appsInCache.length==0){
            window.setCurrentGame(all_data[0].appId);
        }
    }

    window.loadDataUser(true);

    (function(){

        var parallax = document.querySelector("#header-img"),
            speed = 0.5;

        document.getElementById("games-main").onscroll = function(){
            var windowYOffset = document.getElementById("games-main").scrollTop;
            var elBackgrounPos = "50% " + (windowYOffset * speed) + "px";

            parallax.style.backgroundPosition = elBackgrounPos;
        };

        var users = app_getUsers();
        options = [];

        for (const user of users) {
            var option = {};
            option.name = user.name;
            option.onClick = function(){
                app_data["apps"][currentGame.appId]["user"] = user.name;
                app_saveData();
                setCurrentGame(currentGame.appId);
            }
            options.push(option);
        }

        $("#info-user").click(function(e){
            console.log($("#info-user").width());
            showOptions({
                width: $("#info-user").width(),
                left: $("#info-user").offset().left,
                top: $("#info-user").offset().top,
                maxHeight: 200
             }, options, e);
        });
    })();
</script>